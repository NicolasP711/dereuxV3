{% extends 'base.html.twig' %}

{% block title %}{{artwork.title}}{% endblock %}

{% block body %}
  {% include 'partials/flashes/error.html.twig' %}
  {% include 'partials/flashes/success.html.twig' %}
  <h1 class="text-center blogArticle my-4 col-12"><b>{{artwork.title|striptags|slice(0, 100)}}</b></h1>

    <article>

        <img id="artworkImg" class="d-block me-auto ms-auto mt-4" src="{{ asset('img/artworks/' ~ artwork.picture)|imagine_filter('artwork') }}" alt="">
        <p class="mb-4 text-center">Titre de l'oeuvre: <b>{{artwork.title}}</b> Créée par <b>{{ artwork.artist }}</b> le <b>{{ artwork.creationDate ? artwork.creationDate|date('Y-m-d') : '' }}</b> </p>


        <div class="blogArticle mb-4 col-12">{{ artwork.description|purify }}</div>
        <p>Publié le <b>{{ artwork.publicationDate ? artwork.publicationDate|date('Y-m-d à H:i:s') : '' }}</b> par {% if artwork.author is empty %}<b>Utilisateur supprimé</b>{% else %}<b>{{ artwork.author.pseudonym }}</b>{% endif %}</p>

    </article>


    <div id="profilBtn" class="mt-5">
        {% if is_granted("ROLE_ADMIN") %}
            <a class="btn btn-warning mb-5" href="{{ path('admin_artwork_index') }}">Gestion des oeuvres</a>
            <a class="btn defaultBtn mb-5" href="{{ path('artwork_index') }}">Retour aux oeuvres</a>
            <a class="btn btn-primary mb-5" href="{{ path('artwork_edit', {'slug': artwork.slug}) }}">Éditer</a>
            <form method="post" action="{{ path('artwork_delete', {'slug': artwork.slug}) }}" onsubmit="return confirm('Voulez vous vraiment supprimer cette oeuvre ?');">
                <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ artwork.id) }}">
                <button class="btn btn-danger mb-5">Supprimer</button>
            </form>
        {% else %}
            <a class="btn defaultBtn mb-5" href="{{ path('artwork_index') }}">Retour aux oeuvres</a>
        {% endif %}
    </div>

    {% if artwork.ArtworkComments is empty %}
      <p class="text-center alert alert-warning mt-5">Aucun commentaire n'a été publié pour le moment.</p>
    {% else %}
      <p class="text-center my-4">Commentaires: {{ artwork.ArtworkComments|length }}</p>
      <div class="mt-5 mb-3 text-center">
        {#<div class="d-inline-block">
            {{ knp_pagination_render(comments) }}
        </div>#}
      </div>
      <div class="mt-5 mb-3 text-center">
        <div class="d-inline-block">
            {# Affichage du menu permettant de naviguer entre les différentes pages #}
            {{ knp_pagination_render(comments) }}
        </div>
      </div>
      {% for comment in comments %}

      <div class="comment my-4 text-justify float-left">

        {% if comment.author.photo is null %}
            <img class="rounded-circle me-1" width="40" height="40" src="{{ asset('img/profil_default.png')|imagine_filter('profil') }}" alt="image de profil">
        {% else %}
            <img class="rounded-circle me-1" width="40" height="40" src="{{ asset('img/users/' ~ comment.author.photo)|imagine_filter('profil') }}" alt="image de profil">
        {% endif %}

        <h4><strong>{{ comment.author.pseudonym }}</strong></h4> <span>- {{ comment.publicationDate|date('d/m/Y à H\\hi') }}</span>
        <p class="mt-2" id="commentContent">{{ comment.content|purify }}</p>

          {% if is_granted('ROLE_ADMIN') or app.user.id is defined and comment.author.id == app.user.id %}
              <a onclick="return confirm('Souhaitez vous vraiment supprimer ce commentaire ?');" class="btn btn-danger" href="{{ path('delete_artwork_comment', {'slug': comment.slug, csrf_token: csrf_token('delete_artwork_comment_' ~ comment.id)}) }}"><i class="text-white fas fa-trash me-1"></i>Supprimer</a>
          {% endif %}

          {% if is_granted('ROLE_USER') and app.user.id is defined and comment.author.id == app.user.id %}
              <a class="btn altBtn" href="{{ path('artwork_comment_edit', {'slug': comment.slug}) }}"><i class="fas fa-edit me-1"></i>Modifier</a>
          {% endif %}
          <hr>


      </div>

      {% endfor %}
      <div class="mt-5 mb-3 text-center">
        <div class="d-inline-block">
            {# Affichage du menu permettant de naviguer entre les différentes pages #}
            {{ knp_pagination_render(comments) }}
        </div>
      </div>
    {% endif %}

    <div>
        {# Liste des commentaires lié à l'oeuvre #}
        {% if is_granted('ROLE_USER') %}
            <h2 class="h3 text-center my-5">Ajouter un commentaire :</h2>
            {{ form_start(form) }}
                  <div class="form-group mb-3">
                      {{ form_row(form.content) }}
                  </div>
                  {{ form_errors(form) }}
                  <div class="form-group mb-3">
                      <div class="g-recaptcha" data-sitekey="{{ google_recaptcha_site_key }}"></div>
                  </div>
                  <div class="form-group mb-3">
                      {{ form_row(form.save) }}
                  </div>
                  {{ form_end(form) }}
        {% else %}
        <div class="d-flex flex-row justify-content-center">
          <button type="button" class="my-4 btn btn-primary"><a class="text-white text-decoration-none"href="{{ path('app_login') }}">Connectez vous pour ajouter un commentaire</a></button>
        </div>
        {% endif %}
      </div>
    {% endblock %}

    {% block stylesheets %}
    {# Insertion du fichier JS dans le block stylesheets, ce n'est pas une erreur, la documentation de Recaptcha préconise en effet d'intégrer ce fichier JS dans le head #}
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
{% endblock %}